---
title: "Leaderboard"
format:
  html:
    theme: cosmo
    toc: false
page-layout: full
execute-dir: project
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(dplyr)
library(reactable)
library(bslib)

# --- Row highlighting by Owner (robust across reactable versions) ---
owner_row_style <- function(row) {
  # row can be a list, data.frame (1 row), or atomic in some edge cases
  owner <- NULL
  if (is.list(row) && !is.null(row$Owner)) owner <- row$Owner
  if (is.data.frame(row) && 'Owner' %in% names(row)) owner <- row[['Owner']][[1]]
  if (is.null(owner) || length(owner) == 0) return(NULL)

  if (owner == 'Ben') {
    list(background = '#e3f2fd')
  } else if (owner == 'Nick') {
    list(background = '#e8f5e9')
  } else if (owner == 'Austin') {
    list(background = '#fdecea')
  } else if (owner == 'Kev') {
    list(background = '#fff9c4')
  } else {
    NULL
  }
}

owner_sum_debug <- readRDS('owner_sum_debug.rds')

# --- Top leaderboard summary ---
summary_tbl <- owner_sum_debug %>%
  transmute(
    Rank = rank,
    Owner = Owner,
    `Final Score` = adj_avg_rank,
    `Base Avg Rank` = avg_rank,
    Adjustment = adj
  ) %>%
  arrange(Rank)

cat('## Standings\n')

reactable(
  summary_tbl,
  searchable = FALSE,
  pagination = FALSE,
  defaultSorted = 'Rank',
  bordered = TRUE,
  striped = TRUE,
  highlight = TRUE,
  columns = list(
    Rank = colDef(align = 'center', maxWidth = 80),
    `Final Score` = colDef(align = 'right'),
    `Base Avg Rank` = colDef(align = 'right'),
    Adjustment = colDef(align = 'right')
  ),
  rowStyle = function(row, index, ...) {
    base <- owner_row_style(row)
    bold <- if (!is.null(index) && length(index) == 1 && isTRUE(index == 1)) list(fontWeight = 'bold') else NULL
    c(base, bold)
  }
)

cat('\n\n---\n\n')
cat('## Adjustment Breakdown\n')

# --- Detailed breakdown table ---
detail_tbl <- owner_sum_debug %>%
  select(
    rank, Owner, avg_rank, adj_avg_rank, adj,
    titles, five_set_wins, grass_wins,
    aces_per_service_point, dfs_per_service_point, bagels_surrendered,
    adj_titles, adj_five_set, adj_grass, adj_aces, adj_bagels, adj_dfs
  ) %>%
  rename(
    Rank = rank,
    `Final Score` = adj_avg_rank,
    `Base Avg Rank` = avg_rank,
    `Total Adj` = adj,
    Titles = titles,
    `Five-Set Wins` = five_set_wins,
    `Grass Wins` = grass_wins,
    `Aces / SP` = aces_per_service_point,
    `DFs / SP` = dfs_per_service_point,
    `Bagels Surrendered` = bagels_surrendered,
    `Adj: Titles` = adj_titles,
    `Adj: Five-Set` = adj_five_set,
    `Adj: Grass` = adj_grass,
    `Adj: Aces` = adj_aces,
    `Adj: Bagels` = adj_bagels,
    `Adj: DFs` = adj_dfs
  )

reactable(
  detail_tbl,
  searchable = TRUE,
  defaultSorted = 'Final Score',
  defaultSortOrder = 'asc',
  pagination = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  striped = TRUE,
  rowStyle = function(row, index, ...) owner_row_style(row),
  columns = list(
    Rank = colDef(align = 'center', maxWidth = 80),
    Owner = colDef(minWidth = 120),
    `Base Avg Rank` = colDef(align = 'right'),
    `Final Score` = colDef(align = 'right'),
    `Total Adj` = colDef(align = 'right'),
    Titles = colDef(align = 'right'),
    `Five-Set Wins` = colDef(align = 'right'),
    `Grass Wins` = colDef(align = 'right'),
    `Aces / SP` = colDef(align = 'right'),
    `DFs / SP` = colDef(align = 'right'),
    `Bagels Surrendered` = colDef(align = 'right')
  )
)

cat('\n\n---\n\n')
cat('## Player-level Stats\n')
cat('\n\n')

roster_tbl <- readRDS('roster_tbl.rds')

reactable(
  roster_tbl,
  searchable = TRUE,
  filterable = TRUE,
  pagination = FALSE,
  highlight = TRUE,
  bordered = TRUE,
  striped = TRUE,
  defaultSorted = 'Race Rank',
  defaultSortOrder = 'asc',
  rowStyle = function(row, index, ...) owner_row_style(row),
  columns = list(
    Owner = colDef(minWidth = 110),
    Player = colDef(minWidth = 220),
    Range = colDef(minWidth = 90),
    `Race Rank` = colDef(align = 'right', maxWidth = 110),
    `Race Points` = colDef(align = 'right', maxWidth = 110),
    `Live Rank` = colDef(align = 'right', maxWidth = 110),
    Titles = colDef(align = 'right', maxWidth = 90),
    `Five-Set Wins` = colDef(align = 'right', maxWidth = 120),
    `Grass Wins` = colDef(align = 'right', maxWidth = 110),
    `Bagels Surrendered` = colDef(align = 'right', minWidth = 140),
    Aces = colDef(align = 'right', maxWidth = 90),
    DFs = colDef(align = 'right', maxWidth = 90),
    `Service Points` = colDef(align = 'right', minWidth = 130),
    `Aces / SP` = colDef(align = 'right', maxWidth = 110),
    `DFs / SP` = colDef(align = 'right', maxWidth = 110)
  )
)

```
